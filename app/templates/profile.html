<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

{% extends 'base.html' %}

{% block title %}Личный кабинет — ArtNails Academy{% endblock %}

{% if session.get('logged_out') %}
    <p>Вы вышли. Для доступа к профилю войдите снова.</p>
{% else %}
    <div class="profile-page">
        <!-- весь профиль здесь -->
    </div>
{% endif %}


{% block content %}

<div class="profile-page">
    <!-- Белый верхний блок -->
    <div class="profile-header">
        <div class="profile-header-text">
            <h1>Личный кабинет</h1>
            <p>Управляйте своим обучением</p>
        </div>
        <button class="btn-buy-course" onclick="window.location.href='{{ url_for('enroll.enroll_page') }}'">+ Купить курс</button>
    </div>

    <!-- Основной контент -->
    <div class="profile-content">
        <!-- Карточка пользователя -->
        <div class="profile-card">
            <!-- Аватар -->
            <img src="{{ url_for('static', filename=user.avatar) if user.avatar else url_for('static', filename='img/default_avatar.png') }}"
                 alt="Аватар" class="profile-avatar">
            <div class="profile-user-info">
                <h2>{{ user.first_name }} {{ user.last_name }}</h2>
                <p class="profile-email">{{ user.email }}</p>
                <p class="profile-role">Студент с {{ user.registration_date.strftime('%d %B %Y') }}</p>
            </div>

            <!-- Статистика -->
            <div class="profile-stats">
                <div class="stat stat-purchased">
                    <div class="stat-number">{{ stats['courses'] }}</div>
                    <div class="stat-label">Курсов куплено</div>
                </div>
                <div class="stat stat-completed">
                    <div class="stat-number">{{ stats['completed'] }}</div>
                    <div class="stat-label">Курсов завершено</div>
                </div>
                <div class="stat stat-certificates">
                    <div class="stat-number">{{ stats['certificates'] }}</div>
                    <div class="stat-label">Сертификатов</div>
                </div>
            </div>

            <!-- Кнопки вкладок -->
            <div class="profile-buttons">
                <button class="tab-btn active" data-tab="my-courses">Мои курсы</button>
                <button class="tab-btn" data-tab="certificates">Сертификаты</button>
                <button class="tab-btn" data-tab="profile-info">Профиль</button>
            </div>
        </div>

        <!-- Блоки контента справа, меняются через JS -->
          <div id="tab-content">
            <div class="my-courses" style="display:block;">
                <h2 class="tab-title">Мои курсы</h2>

                <div class="courses-grid">
                    {% for course in courses %}
                    <div class="course-card profile-course-card">
                        <!-- Картинка -->
                        <img src="{{ url_for('static', filename=course.image) }}"
                             alt="Курс"
                             class="course-image">

                        <!-- Уровень -->
                        <div class="course-info">
                            <div class="course-level-row">
                                <div class="course-level {{ course.difficulty|lower }}">
                                    {{ course.difficulty }}
                                </div>

                                {% if course.status == 'completed' %}
                                    <div class="course-certificate">Сертификат готов</div>
                                {% endif %}
                            </div>

                            <!-- НАЗВАНИЕ КУРСА (ВАЖНО) -->
                            <div class="course-title">
                                {{ course.title }}
                            </div>

                            <!-- КРАТКОЕ ОПИСАНИЕ -->
                            <div class="course-desc">
                                {{ course.short_description }}
                            </div>
                        </div>
                        <!-- ПРОГРЕСС -->
                        <div class="course-progress-info">
                            <span>Прогресс</span>
                            <span>{{ course.completed_modules }}/{{ course.total_modules }} модулей</span>
                        </div>

                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ course.progress }}%;"></div>
                        </div>

                        <div class="progress-percent">{{ course.progress }}%</div>

                        <!-- МЕТА -->
                        <div class="course-meta">
                            <span>
                                Преподаватель: {{ course.teacher }}
                            </span>
                            <span>
                                {{ course.purchase_date.strftime('%d.%m.%Y') }}
                            </span>
                        </div>

                        <!-- КНОПКИ -->
                        {% if course.status != 'completed' %}
                            <button class="btn-continue" onclick="window.location.href='{{ url_for('course.course_page', course_id=course.id) }}'">
                                <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Пример иконки: стрелка вправо -->
                                    <path d="M4 2L12 8L4 14V2Z"/>
                                </svg>
                                Продолжить
                            </button>
                        {% else %}
                            <div class="course-buttons">
                                <button class="btn-view" onclick="window.location.href='{{ url_for('course.course_page', course_id=course.id) }}'">
                                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <!-- Иконка глаза -->
                                        <path d="M8 3C4 3 1.333 8 8 13C14.667 8 12 3 8 3ZM8 11C6.343 11 5 9.657 5 8C5 6.343 6.343 5 8 5C9.657 5 11 6.343 11 8C11 9.657 9.657 11 8 11ZM8 6C7.447 6 7 6.447 7 7C7 7.553 7.447 8 8 8C8.553 8 9 7.553 9 7C9 6.447 8.553 6 8 6Z"/>
                                    </svg>
                                    Посмотреть
                                </button>
                                    <button class="btn-certificate">
                                        <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <!-- Иконка скачивания -->
                                            <path d="M4 8H7V12H9V8H12L8 4L4 8Z"/>
                                        </svg>
                                        Сертификат
                                    </button>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <!-- Вкладка Профиль -->
            <div class="profile-info" style="display:none;">
                <h2 class="profile-tab-title">Настройки профиля</h2>

                <div class="profile-settings-card" style="width:831px; height:589px;">
                    <!-- Левая часть: аватар и изменение фото -->
                    <div class="profile-settings-left">
                        <!-- Аватар -->
                        <img
                            src="{{ url_for('static', filename=user.avatar) if user.avatar else url_for('static', filename='img/default_avatar.png') }}"
                            alt="Аватар"
                            class="profile-settings-avatar"
                            id="profileAvatar"
                        >

                        <!-- Кнопка изменения фото -->
                        <button
                            type="button"
                            class="btn-change-photo"
                            id="btnChangePhoto"
                        >
                            <svg
                                class="btn-icon"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <!-- Иконка галереи -->
                                <path d="M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM19 19H5V5H19V19ZM12 8C10.9 8 10 8.9 10 10C10 11.1 10.9 12 12 12C13.1 12 14 11.1 14 10C14 8.9 13.1 8 12 8ZM5 19L8 14.5L11 17.5L15 12.5L19 19H5Z"/>
                            </svg>
                            Изменить фото
                        </button>

                        <!-- Скрытый input -->
                        <input
                            type="file"
                            id="inputAvatar"
                            accept=".jpg,.jpeg,.png"
                            hidden
                        >

                        <!-- Подсказка -->
                        <p class="photo-note">
                            JPG, PNG. Максимум 2 MB
                        </p>
                    </div>

                    <!-- Правая часть: поля для редактирования -->
                    <div class="profile-settings-right">
                        <label>Имя</label>
                        <input type="text" id="profileName" value="{{ user.first_name }}">

                        <label>Фамилия</label>
                        <input type="text" id="profileLastName" value="{{ user.last_name }}">

                        <label>Email</label>
                        <input type="email" id="profileEmail" value="{{ user.email }}">

                        <label>Старый пароль</label>
                        <input type="password" id="profileOldPassword">

                        <label>Новый пароль</label>
                        <input type="password" id="profileNewPassword">
                    </div>

                    <!-- Кнопки снизу карточки -->
                    <div class="profile-settings-actions" style="position:absolute; bottom:16px; right:24px; display:flex; gap:10px;">
                        <button class="btn-cancel" id="btnCancel">Отменить</button>

                        <button class="btn-save" id="btnSave">
                            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <!-- Символ сим-карты -->
                                <path d="M21 3H3C2 3 1 4 1 5V19C1 20 2 21 3 21H21C22 21 23 20 23 19V5C23 4 22 3 21 3ZM21 19H3V5H21V19ZM7 7H17V17H7V7Z"/>
                            </svg>
                            Сохранить изменения
                        </button>
                    </div>
                </div>
            </div>

<!-- Модалка обрезки аватара -->
<div class="avatar-modal" id="avatarModal">
    <div class="avatar-modal-content">
        <h3 class="avatar-modal-title">Обрезка фото</h3>

        <div class="avatar-crop-area">
            <div class="avatar-crop-wrapper">
                <img id="cropImage">
                <div class="crop-grid"></div>
            </div>
        </div>

        <input
            type="range"
            id="zoomRange"
            min="1"
            max="2.5"
            step="0.01"
            value="1"
        >

        <div class="avatar-modal-actions">
            <button class="btn-cancel" id="cancelCrop">Отмена</button>
            <button class="btn-save" id="saveCrop">Сохранить</button>
        </div>
    </div>
</div>

<canvas id="avatarCanvas" width="300" height="300" hidden></canvas>

<!-- JS -->
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>
{% endblock %}