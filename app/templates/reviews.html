{% extends 'base.html' %}

{% block title %}Отзывы — ArtNails Academy{% endblock %}

{% block content %}
<main class="reviews-page">

    <!-- Верхний белый блок -->
    <section class="reviews-header">
        <div class="reviews-header-content">
            <h1 class="reviews-title">Отзывы студентов</h1>
            <button class="btn-add-review">+ Оставить отзыв</button>
        </div>
    </section>

    <!-- Фильтры -->
    <section class="reviews-filters">
        <div class="reviews-filters-card">
            <div class="filter-wrapper">
                <label>Фильтр по курсу</label>
                <select id="review-course-filter">
                    <option value="">Все курсы</option>
                    {% for course in courses %}
                    <option value="{{ course.id_course }}">{{ course.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-wrapper">
                <label>Сортировать по</label>
                <select id="review-sort-filter">
                    <option value="newest">Сначала новые</option>
                    <option value="oldest">Сначала старые</option>
                    <option value="rating">По рейтингу</option>
                </select>
            </div>
        </div>
    </section>

    <!-- Список отзывов -->
    <section class="reviews-list-section">
        <div class="reviews-list-container" id="reviews-container">
            {% for review in reviews %}
            <div class="review-card">
                <img
                    class="review-avatar"
                    src="{{ url_for('static', filename=review.user.avatar) if review.user.avatar else url_for('static', filename='img/default_avatar.png') }}"
                    alt="avatar"
                >
                <div class="review-header">
                    <div class="review-name">{{ review.user.first_name }} {{ review.user.last_name }}</div>
                    <div class="review-course">{{ review.course.title }}</div>
                </div>
                <div class="review-stars">
                    {% for i in range(1,6) %}
                        {% if i <= review.rating %}
                            <img src="{{ url_for('static', filename='icons/star-filled.svg') }}" alt="star" class="star">
                        {% else %}
                            <img src="{{ url_for('static', filename='icons/star-empty.svg') }}" alt="star" class="star">
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="review-date">{{ review.created_at.strftime("%d.%m.%Y") }}</div>
                <p class="review-text">{{ review.comment }}</p>
            </div>
            {% endfor %}
        </div>
    </section>
<div class="modal-overlay" id="add-review-modal">
    <div class="modal-content">

        <h2 class="modal-title">Оставить отзыв</h2>

        <label>Курс</label>
        <select id="review-course">
            {% for course in user_courses %}
                <option value="{{ course.id_course }}">{{ course.title }}</option>
            {% endfor %}
        </select>

        <label>Оценка</label>
        <div id="review-rating" class="review-stars-input">
            {% for i in range(1,6) %}
                <span class="star" data-value="{{ i }}">☆</span>
            {% endfor %}
        </div>

        <label>Комментарий</label>
        <textarea id="review-comment" placeholder="Напишите отзыв..."></textarea>

        <div class="modal-buttons">
            <button id="submit-review" class="btn-primary">Отправить</button>
            <button id="close-review-modal" class="btn-secondary">Отмена</button>
        </div>

    </div>
</div>


</main>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // ==========================
    // Верхний блок: заголовок и кнопка "Оставить отзыв"
    // ==========================
    const headerTitle = document.querySelector(".reviews-title");
    const addBtn = document.querySelector(".btn-add-review");

    headerTitle.style.opacity = 0;
    headerTitle.style.transform = "translateY(20px)";
    addBtn.style.opacity = 0;
    addBtn.style.transform = "translateY(20px)";

    setTimeout(() => {
        headerTitle.style.transition = "all 1s ease";
        headerTitle.style.opacity = 1;
        headerTitle.style.transform = "translateY(0)";
    }, 200);

    setTimeout(() => {
        addBtn.style.transition = "all 1s ease";
        addBtn.style.opacity = 1;
        addBtn.style.transform = "translateY(0)";
    }, 600);

    // ==========================
    // Фильтры
    // ==========================
    const filters = document.querySelector(".reviews-filters-card");
    filters.style.opacity = 0;
    filters.style.transform = "translateY(20px)";
    setTimeout(() => {
        filters.style.transition = "all 0.8s ease";
        filters.style.opacity = 1;
        filters.style.transform = "translateY(0)";
    }, 1000);

    // ==========================
    // Карточки отзывов
    // ==========================
    const reviewsContainer = document.getElementById("reviews-container");

    function isInViewport(el) {
        const rect = el.getBoundingClientRect();
        return rect.top < window.innerHeight - 50;
    }

    function animateReviewCards() {
        const cards = document.querySelectorAll(".review-card");

        cards.forEach((card, i) => {
            if (!card.classList.contains("animated") && isInViewport(card)) {
                card.classList.add("animated");
                setTimeout(() => {
                    card.style.opacity = 1;
                    card.style.transform = "translateY(0)";

                    // Анимация элементов внутри карточки
                    const avatar = card.querySelector(".review-avatar");
                    const header = card.querySelector(".review-header");
                    const stars = card.querySelector(".review-stars");
                    const date = card.querySelector(".review-date");
                    const text = card.querySelector(".review-text");
                    const deleteBtn = card.querySelector(".btn-delete-review");

                    if (avatar) setTimeout(() => { avatar.style.opacity = 1; avatar.style.transform = "translateY(0)"; }, 100);
                    if (header) setTimeout(() => { header.style.opacity = 1; header.style.transform = "translateY(0)"; }, 200);
                    if (stars) setTimeout(() => { stars.style.opacity = 1; stars.style.transform = "translateY(0)"; }, 300);
                    if (date) setTimeout(() => { date.style.opacity = 1; date.style.transform = "translateY(0)"; }, 400);
                    if (text) setTimeout(() => { text.style.opacity = 1; text.style.transform = "translateY(0)"; }, 500);
                    if (deleteBtn) setTimeout(() => { deleteBtn.style.opacity = 1; deleteBtn.style.transform = "translateY(0)"; }, 600);

                }, i * 150);
            }
        });
    }

    window.addEventListener("scroll", animateReviewCards);
    window.addEventListener("resize", animateReviewCards);
    animateReviewCards();

    // ⚡ После перерендеринга карточек через fetch
    const originalRenderReviews = window.renderReviews;
    window.renderReviews = function(reviews) {
        originalRenderReviews(reviews);
        animateReviewCards();
    };
});

</script>
<script src="{{ url_for('static', filename='js/reviews_filter.js') }}"></script>
{% endblock %}
